# This is a basic workflow to help you get started with Actions

name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4
      - name: Build and Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            cd crypto-bot/auction-service
            git pull
            export NVM_DIR="$HOME/.nvm"
            source "$NVM_DIR/nvm.sh"
            nvm use 22
            npm i
            npm run build
            rm -rf /var/www/tagwaiter.ru/dist/*
            cp -r public/* /var/www/tagwaiter.ru/dist/
            docker compose pull || true
            docker compose down
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ MongoDB –∏ Redis —Å–Ω–∞—á–∞–ª–∞
            docker compose up -d mongo redis
            # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ MongoDB
            sleep 15
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º replica set (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
            docker compose exec -T mongo mongosh --quiet --eval "try { rs.status().ok } catch(e) { 0 }" | grep -q "1" || \
            docker compose exec -T mongo mongosh --eval "rs.initiate({_id:'rs0',members:[{_id:0,host:'mongo:27017'}]})" || true
            # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ replica set
            sleep 5
            # –ó–∞–ø—É—Å–∫–∞–µ–º API
            docker compose up -d --build
      
permissions:
  contents: write